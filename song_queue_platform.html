<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SongQueue - Musik Warteschlange</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(75, 0, 130, 0.1) 0%, transparent 50%);
            animation: pulse 4s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .logo {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 30px rgba(255, 215, 0, 0.5); }
            to { text-shadow: 0 0 40px rgba(255, 215, 0, 0.8); }
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 10px;
            backdrop-filter: blur(10px);
        }

        .tab-btn {
            background: linear-gradient(45deg, #333, #555);
            border: none;
            color: white;
            padding: 12px 24px;
            margin: 0 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .tab-btn:hover::before {
            left: 100%;
        }

        .tab-btn.active {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .content-section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glass-card {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #ffd700;
            font-weight: bold;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        .btn {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #666, #888);
            color: white;
        }

        .song-queue {
            margin-top: 30px;
        }

        .song-item {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            border-left: 4px solid #333;
        }

        .song-item:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        }

        .song-item.gold {
            border-left-color: #ffd700;
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.2), rgba(0, 0, 0, 0.8));
        }

        .song-item.silver {
            border-left-color: #c0c0c0;
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.2), rgba(0, 0, 0, 0.8));
        }

        .song-item.bronze {
            border-left-color: #cd7f32;
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.2), rgba(0, 0, 0, 0.8));
        }

        .position-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .position-badge.gold {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
        }

        .position-badge.silver {
            background: linear-gradient(45deg, #c0c0c0, #e8e8e8);
            color: #000;
        }

        .position-badge.bronze {
            background: linear-gradient(45deg, #cd7f32, #e49b61);
            color: #000;
        }

        .position-badge.default {
            background: #333;
            color: white;
        }

        .song-info {
            flex-grow: 1;
        }

        .song-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .song-meta {
            color: #aaa;
            font-size: 14px;
        }

        .boost-btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .boost-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .room-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #333;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(30px);
        }

        .file-upload {
            border: 2px dashed rgba(255, 215, 0, 0.5);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .file-upload.dragover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.02);
        }

        .room-link {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .copy-btn {
            background: #ffd700;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .audio-player {
            background: rgba(0, 0, 0, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .payment-section {
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.1), rgba(255, 107, 53, 0.1));
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                margin: 5px;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="background-animation"></div>
    
    <div class="container">
        <header class="header">
            <h1 class="logo">🎵 SongQueue</h1>
            <p style="color: #aaa; margin-top: 10px;">Erstelle deinen eigenen Musik-Raum und teile ihn überall!</p>
        </header>

        <nav class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('home')">🏠 Start</button>
            <button class="tab-btn" onclick="showTab('create-room')">➕ Raum erstellen</button>
            <button class="tab-btn" onclick="showTab('join-room')">🚪 Raum beitreten</button>
            <button class="tab-btn" onclick="showTab('my-rooms')">📁 Meine Räume</button>
        </nav>

        <!-- Start Tab -->
        <section id="home" class="content-section active">
            <div class="glass-card">
                <h2 style="color: #ffd700; margin-bottom: 20px;">🎶 Willkommen bei SongQueue!</h2>
                <p style="margin-bottom: 20px;">Erstelle deinen eigenen Musik-Raum, sammle Song-Wünsche von deinen Fans und teile den Link in deiner TikTok Bio oder anderen sozialen Medien!</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                    <div class="glass-card" style="text-align: center;">
                        <h3>🆓 Kostenlos</h3>
                        <p>Erstelle unbegrenzt Räume und sammle Songs völlig kostenlos</p>
                    </div>
                    <div class="glass-card" style="text-align: center;">
                        <h3>💰 Boost-Option</h3>
                        <p>Fans können für Geld ihre Songs nach oben pushen</p>
                    </div>
                    <div class="glass-card" style="text-align: center;">
                        <h3>🔗 Teilbar</h3>
                        <p>Perfekt für TikTok, Instagram und andere Social Media</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Create Room Tab -->
        <section id="create-room" class="content-section">
            <div class="glass-card">
                <h2 style="color: #ffd700; margin-bottom: 20px;">🎪 Neuen Raum erstellen</h2>
                
                <div class="input-group">
                    <label>Raum Name</label>
                    <input type="text" class="input-field" id="roomName" placeholder="z.B. DJ Max's Queue">
                </div>
                
                <div class="input-group">
                    <label>Benutzername</label>
                    <input type="text" class="input-field" id="username" placeholder="Dein Name">
                </div>
                
                <div class="room-settings">
                    <div>
                        <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                            <span>💰 Bezahl-Feature aktivieren</span>
                            <div class="toggle-switch" id="paymentToggle" onclick="togglePayment()">
                                <div class="toggle-slider"></div>
                            </div>
                        </label>
                        
                        <div id="paymentSettings" style="display: none;">
                            <div class="input-group">
                                <label>Preis für Platz 1 (€)</label>
                                <input type="number" class="input-field" id="boostPrice" value="5" min="1">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="createRoom()">🚀 Raum erstellen</button>
                
                <div id="newRoomResult" style="display: none;">
                    <div class="room-link">
                        <div>
                            <strong>Dein Raum Link:</strong><br>
                            <span id="roomUrl" style="color: #ffd700;"></span>
                        </div>
                        <button class="copy-btn" onclick="copyRoomLink()">📋 Kopieren</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Join Room Tab -->
        <section id="join-room" class="content-section">
            <div class="glass-card">
                <h2 style="color: #ffd700; margin-bottom: 20px;">🎵 Song hinzufügen</h2>
                
                <div class="input-group">
                    <label>Raum Code oder Link</label>
                    <input type="text" class="input-field" id="joinRoomCode" placeholder="Raum Code eingeben">
                </div>
                
                <button class="btn" onclick="joinRoom()">🚪 Raum betreten</button>
            </div>
            
            <div id="songSubmissionArea" style="display: none;">
                <div class="glass-card">
                    <h3 style="color: #ffd700; margin-bottom: 20px;">🎶 Song hinzufügen</h3>
                    
                    <div class="nav-tabs" style="margin-bottom: 20px;">
                        <button class="tab-btn active" onclick="showSubmissionMethod('link')">🔗 Link</button>
                        <button class="tab-btn" onclick="showSubmissionMethod('file')">📁 Datei</button>
                    </div>
                    
                    <div id="linkSubmission" class="submission-method">
                        <div class="input-group">
                            <label>Song Titel</label>
                            <input type="text" class="input-field" id="songTitle" placeholder="Song Name">
                        </div>
                        
                        <div class="input-group">
                            <label>Artist</label>
                            <input type="text" class="input-field" id="songArtist" placeholder="Künstler Name">
                        </div>
                        
                        <div class="input-group">
                            <label>Link (YouTube, Spotify, etc.)</label>
                            <input type="url" class="input-field" id="songLink" placeholder="https://...">
                        </div>
                    </div>
                    
                    <div id="fileSubmission" class="submission-method" style="display: none;">
                        <div class="file-upload" onclick="document.getElementById('audioFile').click()">
                            <p>📁 Klicke hier oder ziehe eine Audio-Datei hierher</p>
                            <p style="color: #aaa; font-size: 14px; margin-top: 10px;">MP3, WAV, M4A unterstützt</p>
                            <input type="file" id="audioFile" accept="audio/*" style="display: none;" onchange="handleFileSelect(this)">
                        </div>
                        <div id="fileInfo" style="display: none; margin-top: 15px;"></div>
                    </div>
                    
                    <div class="input-group">
                        <label>Dein Name (optional)</label>
                        <input type="text" class="input-field" id="submitterName" placeholder="Anonym">
                    </div>
                    
                    <button class="btn" onclick="submitSong()">➕ Song hinzufügen (Kostenlos)</button>
                    
                    <div id="boostSection" class="payment-section" style="display: none;">
                        <h4 style="color: #ffd700; margin-bottom: 15px;">🚀 Song auf Platz 1 boosten</h4>
                        <p>Bringe deinen Song direkt an die Spitze der Warteschlange!</p>
                        <button class="boost-btn" onclick="boostSong()" style="margin-top: 15px; padding: 12px 30px; font-size: 16px;">
                            💰 Für <span id="boostPriceDisplay">5</span>€ auf Platz 1
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- My Rooms Tab -->
        <section id="my-rooms" class="content-section">
            <div class="glass-card">
                <h2 style="color: #ffd700; margin-bottom: 20px;">📁 Meine Räume verwalten</h2>
                <p style="margin-bottom: 20px;">Hier siehst du alle deine erstellten Räume und kannst sie verwalten.</p>
                <div id="roomsList"></div>
            </div>
        </section>

        <!-- Song Queue Display -->
        <div id="queueDisplay" style="display: none;">
            <div class="glass-card">
                <h3 style="color: #ffd700; margin-bottom: 20px;">🎵 Aktuelle Warteschlange</h3>
                <div id="songQueue" class="song-queue"></div>
                
                <div class="audio-player" id="audioPlayer" style="display: none;">
                    <h4 style="color: #ffd700; margin-bottom: 15px;">🎧 Jetzt playing</h4>
                    <audio controls style="width: 100%;" id="currentAudio">
                        Dein Browser unterstützt kein Audio.
                    </audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentRoom = null;
        let rooms = {};
        let currentUser = null;

        // Initialize app
        function initApp() {
            loadRoomsFromStorage();
            updateMyRoomsList();
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Create room functionality
        function createRoom() {
            const roomName = document.getElementById('roomName').value;
            const username = document.getElementById('username').value;
            
            if (!roomName || !username) {
                alert('Bitte fülle alle Felder aus!');
                return;
            }
            
            const roomId = generateRoomId();
            const paymentEnabled = document.getElementById('paymentToggle').classList.contains('active');
            const boostPrice = document.getElementById('boostPrice').value || 5;
            
            const room = {
                id: roomId,
                name: roomName,
                owner: username,
                created: new Date().toISOString(),
                paymentEnabled: paymentEnabled,
                boostPrice: parseFloat(boostPrice),
                songs: []
            };
            
            rooms[roomId] = room;
            saveRoomsToStorage();
            
            const roomUrl = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            document.getElementById('roomUrl').textContent = roomUrl;
            document.getElementById('newRoomResult').style.display = 'block';
            
            updateMyRoomsList();
            
            // Clear form
            document.getElementById('roomName').value = '';
            document.getElementById('username').value = '';
        }

        // Join room functionality
        function joinRoom() {
            const roomCode = document.getElementById('joinRoomCode').value;
            
            if (!roomCode) {
                alert('Bitte gib einen Raum Code ein!');
                return;
            }
            
            // Extract room ID from URL or use directly
            const roomId = roomCode.includes('room=') ? 
                roomCode.split('room=')[1].split('&')[0] : roomCode;
            
            if (rooms[roomId]) {
                currentRoom = rooms[roomId];
                document.getElementById('songSubmissionArea').style.display = 'block';
                document.getElementById('queueDisplay').style.display = 'block';
                
                if (currentRoom.paymentEnabled) {
                    document.getElementById('boostSection').style.display = 'block';
                    document.getElementById('boostPriceDisplay').textContent = currentRoom.boostPrice;
                }
                
                updateQueueDisplay();
            } else {
                alert('Raum nicht gefunden!');
            }
        }

        // Submit song functionality
        function submitSong() {
            if (!currentRoom) return;
            
            const submissionMethod = document.querySelector('.submission-method:not([style*="display: none"])').id;
            let songData = {};
            
            if (submissionMethod === 'linkSubmission') {
                const title = document.getElementById('songTitle').value;
                const artist = document.getElementById('songArtist').value;
                const link = document.getElementById('songLink').value;
                
                if (!title || !artist || !link) {
                    alert('Bitte fülle alle Felder aus!');
                    return;
                }
                
                songData = {
                    title: title,
                    artist: artist,
                    link: link,
                    type: 'link'
                };
            } else {
                const fileInput = document.getElementById('audioFile');
                if (!fileInput.files[0]) {
                    alert('Bitte wähle eine Audio-Datei aus!');
                    return;
                }
                
                const file = fileInput.files[0];
                songData = {
                    title: file.name.split('.')[0],
                    artist: 'Unbekannt',
                    file: file,
                    type: 'file'
                };
            }
            
            const submitterName = document.getElementById('submitterName').value || 'Anonym';
            
            const song = {
                id: Date.now(),
                ...songData,
                submitter: submitterName,
                timestamp: new Date().toISOString(),
                boosted: false
            };
            
            currentRoom.songs.push(song);
            saveRoomsToStorage();
            updateQueueDisplay();
            
            // Clear form
            document.getElementById('songTitle').value = '';
            document.getElementById('songArtist').value = '';
            document.getElementById('songLink').value = '';
            document.getElementById('submitterName').value = '';
            document.getElementById('audioFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            
            alert('Song erfolgreich hinzugefügt!');
        }

        // Boost song functionality with payment integration
        function boostSong() {
            const amount = currentRoom.boostPrice;
            showPaymentModal(amount, () => {
                // Success callback - move song to position 1
                if (currentRoom.songs.length > 0) {
                    // Get the most recently added song or create a temporary one for the boost
                    const songTitle = document.getElementById('songTitle').value || 'Geboosteter Song';
                    const songArtist = document.getElementById('songArtist').value || 'Unbekannt';
                    const songLink = document.getElementById('songLink').value || '#';
                    const submitterName = document.getElementById('submitterName').value || 'Anonym';
                    
                    // Create boosted song
                    const boostedSong = {
                        id: Date.now(),
                        title: songTitle,
                        artist: songArtist,
                        link: songLink,
                        type: 'link',
                        submitter: submitterName,
                        timestamp: new Date().toISOString(),
                        boosted: true
                    };
                    
                    // Add to front of queue
                    currentRoom.songs.unshift(boostedSong);
                    saveRoomsToStorage();
                    updateQueueDisplay();
                    
                    // Clear form
                    document.getElementById('songTitle').value = '';
                    document.getElementById('songArtist').value = '';
                    document.getElementById('songLink').value = '';
                    document.getElementById('submitterName').value = '';
                    
                    alert('🚀 Zahlung erfolgreich! Dein Song ist jetzt auf Platz 1!');
                }
            });
        }

        // Show payment modal with multiple payment options
        function showPaymentModal(amount, onSuccess) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
                    border-radius: 20px;
                    padding: 40px;
                    max-width: 500px;
                    width: 90%;
                    text-align: center;
                    border: 1px solid rgba(255, 215, 0, 0.3);
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                ">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">💰 Bezahlung</h2>
                    <p style="color: white; margin-bottom: 30px; font-size: 18px;">
                        Boost deinen Song für <strong style="color: #ffd700;">${amount}€</strong> auf Platz 1!
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <button class="payment-btn" onclick="processPayment('apple-pay', ${amount}, this)" style="
                            background: linear-gradient(45deg, #000, #333);
                            color: white;
                            border: none;
                            padding: 15px 20px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            🍎 Apple Pay
                        </button>
                        
                        <button class="payment-btn" onclick="processPayment('google-pay', ${amount}, this)" style="
                            background: linear-gradient(45deg, #4285f4, #34a853);
                            color: white;
                            border: none;
                            padding: 15px 20px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            🌐 Google Pay
                        </button>
                        
                        <button class="payment-btn" onclick="processPayment('paypal', ${amount}, this)" style="
                            background: linear-gradient(45deg, #0070ba, #003087);
                            color: white;
                            border: none;
                            padding: 15px 20px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            💙 PayPal
                        </button>
                        
                        <button class="payment-btn" onclick="processPayment('stripe', ${amount}, this)" style="
                            background: linear-gradient(45deg, #6772e5, #5469d4);
                            color: white;
                            border: none;
                            padding: 15px 20px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            💳 Kreditkarte
                        </button>
                        
                        <button class="payment-btn" onclick="processPayment('klarna', ${amount}, this)" style="
                            background: linear-gradient(45deg, #ffb3c6, #fb6f92);
                            color: white;
                            border: none;
                            padding: 15px 20px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            🛍️ Klarna
                        </button>
                        
                        <button class="payment-btn" onclick="processPayment('sofort', ${amount}, this)" style="
                            background: linear-gradient(45deg, #ee312a, #d42e26);
                            color: white;
                            border: none;
                            padding: 15px 20px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            ⚡ Sofort
                        </button>
                        
                        <button class="payment-btn" onclick="processPayment('giropay', ${amount}, this)" style="
                            background: linear-gradient(45deg, #004c91, #0066cc);
                            color: white;
                            border: none;
                            padding: 15px 20px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            🏦 Giropay
                        </button>
                        
                        <button class="payment-btn" onclick="processPayment('sepa', ${amount}, this)" style="
                            background: linear-gradient(45deg, #2e7d32, #4caf50);
                            color: white;
                            border: none;
                            padding: 15px 20px;
                            border-radius: 12px;
                            cursor: pointer;
                            font-size: 14px;
                            font-weight: bold;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            🏛️ SEPA
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button onclick="closePaymentModal()" style="
                            background: #666;
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 25px;
                            cursor: pointer;
                            font-weight: bold;
                        ">
                            Abbrechen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store success callback
            window.currentPaymentSuccess = onSuccess;
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePaymentModal();
                }
            });
            
            // Add hover effects to payment buttons
            modal.querySelectorAll('.payment-btn').forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    btn.style.transform = 'translateY(-2px) scale(1.02)';
                    btn.style.boxShadow = '0 8px 25px rgba(0, 0, 0, 0.3)';
                });
                
                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'translateY(0) scale(1)';
                    btn.style.boxShadow = 'none';
                });
            });
        }

        // Process payment
        function processPayment(method, amount, button) {
            // Disable button and show loading
            button.disabled = true;
            button.innerHTML = '⏳ Verarbeite...';
            
            // Simulate payment processing
            setTimeout(() => {
                // In a real app, this would integrate with actual payment processors
                const success = Math.random() > 0.1; // 90% success rate for demo
                
                if (success) {
                    button.innerHTML = '✅ Erfolgreich!';
                    button.style.background = 'linear-gradient(45deg, #4caf50, #66bb6a)';
                    
                    setTimeout(() => {
                        closePaymentModal();
                        if (window.currentPaymentSuccess) {
                            window.currentPaymentSuccess();
                        }
                    }, 1500);
                } else {
                    button.innerHTML = '❌ Fehler - Erneut versuchen';
                    button.style.background = 'linear-gradient(45deg, #f44336, #e57373)';
                    button.disabled = false;
                    
                    setTimeout(() => {
                        button.innerHTML = getPaymentButtonText(method);
                        button.style.background = getPaymentButtonColor(method);
                    }, 3000);
                }
            }, 2000 + Math.random() * 2000); // Random delay between 2-4 seconds
        }

        // Get payment button text
        function getPaymentButtonText(method) {
            const texts = {
                'apple-pay': '🍎 Apple Pay',
                'google-pay': '🌐 Google Pay',
                'paypal': '💙 PayPal',
                'stripe': '💳 Kreditkarte',
                'klarna': '🛍️ Klarna',
                'sofort': '⚡ Sofort',
                'giropay': '🏦 Giropay',
                'sepa': '🏛️ SEPA'
            };
            return texts[method] || method;
        }

        // Get payment button color
        function getPaymentButtonColor(method) {
            const colors = {
                'apple-pay': 'linear-gradient(45deg, #000, #333)',
                'google-pay': 'linear-gradient(45deg, #4285f4, #34a853)',
                'paypal': 'linear-gradient(45deg, #0070ba, #003087)',
                'stripe': 'linear-gradient(45deg, #6772e5, #5469d4)',
                'klarna': 'linear-gradient(45deg, #ffb3c6, #fb6f92)',
                'sofort': 'linear-gradient(45deg, #ee312a, #d42e26)',
                'giropay': 'linear-gradient(45deg, #004c91, #0066cc)',
                'sepa': 'linear-gradient(45deg, #2e7d32, #4caf50)'
            };
            return colors[method] || 'linear-gradient(45deg, #666, #888)';
        }

        // Close payment modal
        function closePaymentModal() {
            const modal = document.querySelector('[style*="backdrop-filter: blur(10px)"]');
            if (modal && modal.parentElement === document.body) {
                document.body.removeChild(modal);
            }
            window.currentPaymentSuccess = null;
        }

        // Update queue display
        function updateQueueDisplay() {
            if (!currentRoom) return;
            
            const queueContainer = document.getElementById('songQueue');
            queueContainer.innerHTML = '';
            
            currentRoom.songs.forEach((song, index) => {
                const songElement = document.createElement('div');
                songElement.className = 'song-item';
                
                let positionClass = 'default';
                let positionText = index + 1;
                
                if (index === 0) {
                    positionClass = 'gold';
                    songElement.classList.add('gold');
                } else if (index === 1) {
                    positionClass = 'silver';
                    songElement.classList.add('silver');
                } else if (index === 2) {
                    positionClass = 'bronze';
                    songElement.classList.add('bronze');
                }
                
                songElement.innerHTML = `
                    <div class="position-badge ${positionClass}">${positionText}</div>
                    <div class="song-info">
                        <div class="song-title">${song.title}</div>
                        <div class="song-meta">
                            ${song.artist} • ${song.submitter} 
                            ${song.boosted ? '• 🚀 Geboostet' : ''}
                            ${song.type === 'file' ? '• 📁 Datei' : '• 🔗 Link'}
                        </div>
                    </div>
                    <div>
                        ${song.type === 'file' ? 
                            `<button class="btn-secondary" onclick="playAudioFile(${song.id})">▶️ Abspielen</button>` :
                            `<a href="${song.link}" target="_blank" class="btn-secondary" style="text-decoration: none; display: inline-block;">🔗 Öffnen</a>`
                        }
                    </div>
                `;
                
                queueContainer.appendChild(songElement);
            });
            
            if (currentRoom.songs.length === 0) {
                queueContainer.innerHTML = '<p style="text-align: center; color: #aaa; padding: 40px;">Noch keine Songs in der Warteschlange...</p>';
            }
        }

        // Play audio file
        function playAudioFile(songId) {
            const song = currentRoom.songs.find(s => s.id === songId);
            if (song && song.file) {
                const audioPlayer = document.getElementById('audioPlayer');
                const audio = document.getElementById('currentAudio');
                
                // Create object URL for the file
                const url = URL.createObjectURL(song.file);
                audio.src = url;
                
                // Update player title
                const playerTitle = audioPlayer.querySelector('h4');
                playerTitle.innerHTML = `🎧 Jetzt playing: ${song.title} - ${song.artist}`;
                
                audioPlayer.style.display = 'block';
                
                // Auto-play with user interaction check
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Auto-play prevented:', error);
                        // Show play button or message
                        alert('Klicke auf Play um die Musik zu starten!');
                    });
                }
                
                // Clean up URL when audio ends
                audio.onended = () => {
                    URL.revokeObjectURL(url);
                    playerTitle.innerHTML = '🎧 Player bereit';
                };
                
                // Clean up URL when new song starts
                audio.onloadstart = () => {
                    if (audio.src !== url) {
                        URL.revokeObjectURL(url);
                    }
                };
            } else {
                alert('Audio-Datei nicht verfügbar. Möglicherweise wurde die Seite neu geladen.');
            }
        }

        // Toggle payment feature
        function togglePayment() {
            const toggle = document.getElementById('paymentToggle');
            const settings = document.getElementById('paymentSettings');
            
            toggle.classList.toggle('active');
            
            if (toggle.classList.contains('active')) {
                settings.style.display = 'block';
            } else {
                settings.style.display = 'none';
            }
        }

        // Show submission method
        function showSubmissionMethod(method) {
            document.querySelectorAll('.submission-method').forEach(el => {
                el.style.display = 'none';
            });
            
            document.querySelectorAll('#songSubmissionArea .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (method === 'link') {
                document.getElementById('linkSubmission').style.display = 'block';
            } else {
                document.getElementById('fileSubmission').style.display = 'block';
            }
            
            event.target.classList.add('active');
        }

        // Handle file selection
        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = `
                    <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px;">
                        <strong>📁 Datei ausgewählt:</strong><br>
                        <span style="color: #ffd700;">${file.name}</span><br>
                        <small style="color: #aaa;">Größe: ${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                    </div>
                `;
                fileInfo.style.display = 'block';
            }
        }

        // Drag and drop functionality
        function setupDragAndDrop() {
            const fileUpload = document.querySelector('.file-upload');
            
            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.classList.add('dragover');
            });
            
            fileUpload.addEventListener('dragleave', () => {
                fileUpload.classList.remove('dragover');
            });
            
            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('audio/')) {
                    document.getElementById('audioFile').files = files;
                    handleFileSelect(document.getElementById('audioFile'));
                }
            });
        }

        // Copy room link
        function copyRoomLink() {
            const roomUrl = document.getElementById('roomUrl').textContent;
            navigator.clipboard.writeText(roomUrl).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Kopiert!';
                btn.style.background = '#4CAF50';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#ffd700';
                }, 2000);
            });
        }

        // Update my rooms list
        function updateMyRoomsList() {
            const roomsList = document.getElementById('roomsList');
            roomsList.innerHTML = '';
            
            const userRooms = Object.values(rooms);
            
            if (userRooms.length === 0) {
                roomsList.innerHTML = '<p style="text-align: center; color: #aaa; padding: 40px;">Du hast noch keine Räume erstellt...</p>';
                return;
            }
            
            userRooms.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = 'glass-card';
                roomElement.style.marginBottom = '20px';
                
                const roomUrl = `${window.location.origin}${window.location.pathname}?room=${room.id}`;
                
                roomElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h3 style="color: #ffd700; margin-bottom: 5px;">${room.name}</h3>
                            <p style="color: #aaa; font-size: 14px;">Erstellt: ${new Date(room.created).toLocaleDateString('de-DE')}</p>
                            <p style="color: #aaa; font-size: 14px;">Songs: ${room.songs.length}</p>
                            ${room.paymentEnabled ? 
                                `<p style="color: #ffd700; font-size: 14px;">💰 Boost: ${room.boostPrice}€</p>` : 
                                `<p style="color: #aaa; font-size: 14px;">🆓 Kostenlos</p>`
                            }
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-secondary" onclick="manageRoom('${room.id}')" style="padding: 8px 16px; font-size: 14px;">
                                ⚙️ Verwalten
                            </button>
                            <button class="btn-secondary" onclick="deleteRoom('${room.id}')" style="padding: 8px 16px; font-size: 14px; background: #ff4444;">
                                🗑️ Löschen
                            </button>
                        </div>
                    </div>
                    
                    <div class="room-link">
                        <div>
                            <strong>Raum Link:</strong><br>
                            <span style="color: #ffd700; font-size: 14px; word-break: break-all;">${roomUrl}</span>
                        </div>
                        <button class="copy-btn" onclick="copyRoomLinkById('${room.id}')">📋 Kopieren</button>
                    </div>
                    
                    ${room.songs.length > 0 ? `
                        <div style="margin-top: 20px;">
                            <h4 style="color: #ffd700; margin-bottom: 10px;">📝 Aktuelle Songs (${room.songs.length})</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${room.songs.slice(0, 5).map((song, index) => `
                                    <div style="background: rgba(0,0,0,0.3); padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${index + 1}. ${song.title}</strong><br>
                                            <small style="color: #aaa;">${song.artist} • ${song.submitter}</small>
                                        </div>
                                        ${song.boosted ? '<span style="color: #ffd700;">🚀</span>' : ''}
                                    </div>
                                `).join('')}
                                ${room.songs.length > 5 ? `<p style="text-align: center; color: #aaa; margin-top: 10px;">... und ${room.songs.length - 5} weitere</p>` : ''}
                            </div>
                        </div>
                    ` : ''}
                `;
                
                roomsList.appendChild(roomElement);
            });
        }

        // Manage room
        function manageRoom(roomId) {
            const room = rooms[roomId];
            if (!room) return;
            
            currentRoom = room;
            document.getElementById('queueDisplay').style.display = 'block';
            updateQueueDisplay();
            
            // Switch to join room tab to show the queue
            showTab('join-room');
            document.getElementById('joinRoomCode').value = roomId;
            document.getElementById('songSubmissionArea').style.display = 'block';
            
            if (room.paymentEnabled) {
                document.getElementById('boostSection').style.display = 'block';
                document.getElementById('boostPriceDisplay').textContent = room.boostPrice;
            }
        }

        // Delete room
        function deleteRoom(roomId) {
            if (confirm('Möchtest du diesen Raum wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
                delete rooms[roomId];
                saveRoomsToStorage();
                updateMyRoomsList();
                
                if (currentRoom && currentRoom.id === roomId) {
                    currentRoom = null;
                    document.getElementById('queueDisplay').style.display = 'none';
                    document.getElementById('songSubmissionArea').style.display = 'none';
                }
            }
        }

        // Copy room link by ID
        function copyRoomLinkById(roomId) {
            const roomUrl = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            navigator.clipboard.writeText(roomUrl).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '✅ Kopiert!';
                btn.style.background = '#4CAF50';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#ffd700';
                }, 2000);
            });
        }

        // Generate room ID
        function generateRoomId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // Save rooms to storage (improved file handling)
        function saveRoomsToStorage() {
            // Store rooms with file references preserved in memory
            // In a real app, files would be uploaded to a server/cloud storage
            const roomsToSave = {};
            Object.keys(rooms).forEach(roomId => {
                const room = { ...rooms[roomId] };
                // Keep file objects in memory for the session
                roomsToSave[roomId] = room;
            });
            
            try {
                // For demo: Store in memory (in real app: send to backend)
                window.songQueueRooms = roomsToSave;
                console.log('Rooms saved to memory:', Object.keys(roomsToSave));
            } catch (error) {
                console.error('Error saving rooms:', error);
            }
        }

        // Load rooms from storage (improved file handling)
        function loadRoomsFromStorage() {
            try {
                // Load from memory storage
                if (window.songQueueRooms) {
                    rooms = { ...window.songQueueRooms };
                    console.log('Rooms loaded from memory:', Object.keys(rooms));
                } else {
                    rooms = {};
                }
            } catch (error) {
                console.error('Error loading rooms:', error);
                rooms = {};
            }
        }

        // Check for room parameter in URL
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomParam = urlParams.get('room');
            
            if (roomParam) {
                document.getElementById('joinRoomCode').value = roomParam;
                showTab('join-room');
                // Auto-join the room if it exists
                setTimeout(() => {
                    if (rooms[roomParam]) {
                        joinRoom();
                    }
                }, 500);
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupDragAndDrop();
            checkUrlParams();
        });

        // Add some demo data for testing
        function addDemoData() {
            const demoRoom = {
                id: 'demo123',
                name: 'Demo Raum',
                owner: 'TestUser',
                created: new Date().toISOString(),
                paymentEnabled: true,
                boostPrice: 5,
                songs: [
                    {
                        id: 1,
                        title: 'Beispiel Song 1',
                        artist: 'Demo Artist',
                        link: 'https://example.com',
                        type: 'link',
                        submitter: 'Fan123',
                        timestamp: new Date().toISOString(),
                        boosted: true
                    },
                    {
                        id: 2,
                        title: 'Beispiel Song 2',
                        artist: 'Another Artist',
                        link: 'https://example.com',
                        type: 'link',
                        submitter: 'MusicLover',
                        timestamp: new Date().toISOString(),
                        boosted: false
                    }
                ]
            };
            
            rooms['demo123'] = demoRoom;
            updateMyRoomsList();
        }

        // Add demo data after a short delay
        setTimeout(addDemoData, 1000);
    </script>
</body>
</html>